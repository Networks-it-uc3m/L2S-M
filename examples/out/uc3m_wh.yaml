# Copyright 2024 Universidad Carlos III de Madrid
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: apps/v1
kind: Deployment
metadata:
  name: uc3m-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: uc3m-server
  template:
    metadata:
      labels:
        l2sm: "true"
        app: uc3m-server
      annotations:
        # This gives the pod the 10.0.1.2 address on the "video-ue" network (where it receives the stream)
        l2sm/networks: >-
          [{"name":"video-ue","ips":["10.0.1.2/24"]}]
        # This attaches the macvlan (its static IP is defined in the NetAttachDef)
        k8s.v1.cni.cncf.io/networks: macvlan-conf
    spec:
      containers:
        - name: uc3m-server
          image: linuxserver/ffmpeg:version-8.0-cli
          # Run ffmpeg directly
          # command: ["/usr/bin/ffmpeg"]
          args:
            - "-hide_banner"
            - "-nostats"
            # INPUT: bind to 10.0.1.2 and receive UDP TS on port 1234
            - "-i"
            - "udp://10.0.1.2:1234?fifo_size=1048576&overrun_nonfatal=1&reuse=1&localaddr=10.0.1.2"
            # no transcoding â€” just forward
            - "-c:v"
            - "copy"
            - "-c:a"
            - "copy"
            # reduce latency
            - "-flush_packets"
            - "1"
            - "-fflags"
            - "nobuffer"
            - "-max_interleave_delta"
            - "0"
            # OUTPUT: send via macvlan to the receiver at 10.4.16.83:1234
            # (the kernel will normally pick the macvlan src IP for that subnet automatically)
            - "-f"
            - "mpegts"
            - "udp://10.4.16.83:1234?pkt_size=1316&reuse=1&overrun_nonfatal=1"
